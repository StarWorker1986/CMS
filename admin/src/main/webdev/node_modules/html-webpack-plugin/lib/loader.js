"use strict";

const _ = require("lodash");
const loaderUtils = require("loader-utils");

module.exports = function (source) {
    if (this.cacheable) {
        this.cacheable();
    }

    let allLoadersButThisOne = this.loaders.filter(function (loader) {
        return (loader.module || loader.normal) !== module.exports;
    });

    if (allLoadersButThisOne.length > 0) {
        return source;
    }

    if (/\.js$/.test(this.resourcePath)) {
        return source;
    }

    let options = loaderUtils.parseQuery(this.query);
    let template = _.template(source, _.defaults(options, { variable: "data" }));
    let templateVariables = [
      "compilation",
      "webpack",
      "webpackConfig",
      "htmlWebpackPlugin"
    ];
    return "var _ = require(" + loaderUtils.stringifyRequest(this, require.resolve("lodash")) + ");" +
      "module.exports = function (templateParams) {" +
        templateVariables.map(function (variableName) {
            return "var " + variableName + " = templateParams." + variableName;
        }).join(";") + ";" +
        "return (" + template.source + ")();" +
      "}";
}
